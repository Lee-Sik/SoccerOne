<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"   
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="BBS"> 

	<insert id="writeBBS" parameterType="soccer.co.DTO.foot_comunity_DTO">
		INSERT INTO FOOT_BBS
		(BBS_NO, TOPIC, USER_EMAIL, TITLE, CONTENT, WDATE, GOOD, READCOUNT, IMAGEURL, DEL) 
		VALUES(foot_bbs_seq.nextval,#{topic},#{user_email},#{title},#{content},SYSDATE,
				0,0,#{imageurl},0)
	</insert>
	
	<insert id="writeComment" parameterType="soccer.co.DTO.foot_comment_DTO">
		INSERT INTO FOOT_BBS_COMMENT
		(COMMENT_NO, PARENT_BBS_NO, USER_EMAIL, CONTENT, WDATE, DEL) 
		VALUES(foot_comment_seq.nextval,#{parent_bbs_no},#{user_email},#{content},SYSDATE,0)
	</insert>
	
	<select id="getCommentList" parameterType="java.lang.Integer" resultType="soccer.co.DTO.foot_comment_DTO">
	<![CDATA[
  			SELECT * FROM FOOT_BBS_COMMENT
  			WHERE PARENT_BBS_NO = #{parent_bbs_no}
 			ORDER BY COMMENT_NO DESC
  		]]>
	</select>
 
	<select id="getBBSList" resultType="soccer.co.DTO.foot_comunity_DTO">
	<![CDATA[
  			SELECT * FROM FOOT_BBS
 			ORDER BY BBS_NO DESC
  		]]>
	</select>

	<select id="getBBSPagingList" parameterType="soccer.co.DTO.BBSParam" resultType="soccer.co.DTO.foot_comunity_DTO">
			SELECT BBS_NO, TOPIC, USER_EMAIL, TITLE, CONTENT, WDATE, GOOD, READCOUNT, IMAGEURL, DEL
			FROM 	
		( SELECT ROW_NUMBER() OVER (ORDER BY BBS_NO DESC) as rnum,
		BBS_NO, TOPIC, USER_EMAIL, TITLE, CONTENT, WDATE, GOOD, READCOUNT, IMAGEURL, DEL 
		FROM FOOT_BBS
	    WHERE 1 = 1 
	    <if test="s_category != '' and s_category != null and s_keyword != '' and s_keyword != null">
			<if test="s_category == 'title'"> AND TITLE like '%'||#{s_keyword}||'%'</if>	
			<if test="s_category == 'contents'"> AND CONTENT like '%'||#{s_keyword}||'%'</if>	
		</if>
			 ) A
			WHERE rnum between ${start} AND ${end}
	</select>

	<select id="getBBSCount" parameterType="soccer.co.DTO.BBSParam" resultType="java.lang.Integer">
	 
			SELECT NVL(count(*),0) AS cnt
			  FROM  FOOT_BBS  WHERE 1 = 1
		
		<if test="s_category != '' and s_category != null and s_keyword != '' and s_keyword != null">
			<if test="s_category == 'title'"> AND TITLE like '%'||#{s_keyword}||'%'</if>	
			<if test="s_category == 'contents'"> AND CONTENT like '%'||#{s_keyword}||'%'</if>	
		</if>
	</select>


	<select id="getBBS" parameterType="soccer.co.DTO.foot_comunity_DTO" resultType="soccer.co.DTO.foot_comunity_DTO">
			SELECT BBS_NO, TOPIC, USER_EMAIL, TITLE, CONTENT, WDATE, GOOD, READCOUNT, IMAGEURL, DEL
			FROM FOOT_BBS
			WHERE bbs_no=#{bbs_no}
	</select>
	
	<update id="incrementReadCount" parameterType="soccer.co.DTO.foot_comunity_DTO">
		UPDATE FOOT_BBS SET
		READCOUNT = READCOUNT+1
		WHERE bbs_no=#{bbs_no}
	</update>
	
	<insert id="bbsLike" parameterType="soccer.co.DTO.foot_like_DTO">
		INSERT INTO FOOT_BBS_LIKE
		(PARENT_BBS_NO, USER_EMAIL) 
		VALUES(#{parent_bbs_no}, #{user_email})
	</insert>
	
	<update id="bbsLikeCount" parameterType="soccer.co.DTO.foot_comunity_DTO">
		UPDATE FOOT_BBS SET
		GOOD = GOOD+1
		WHERE BBS_NO=#{bbs_no}
	</update>
	
	<delete id="bbsLikeDel" parameterType="soccer.co.DTO.foot_like_DTO">
		DELETE FROM FOOT_BBS_LIKE
		WHERE PARENT_BBS_NO = #{parent_bbs_no}
		AND USER_EMAIL = #{user_email}
	</delete>
	
	<update id="bbsLikeCountDel" parameterType="soccer.co.DTO.foot_comunity_DTO">
		UPDATE FOOT_BBS SET
		GOOD = GOOD-1
		WHERE BBS_NO=#{bbs_no}
	</update>
	
	<select id="getLike" parameterType="soccer.co.DTO.foot_like_DTO" resultType="soccer.co.DTO.foot_like_DTO">
			SELECT *
			FROM FOOT_BBS_LIKE
			WHERE PARENT_BBS_NO=#{parent_bbs_no}
			AND USER_EMAIL=#{user_email}
	</select>
	
	
	<update id="replyBBSUpdate" parameterType="soccer.co.DTO.foot_comunity_DTO">
		UPDATE FOOT_BBS SET
		STEP=STEP+1
		WHERE REF=(SELECT REF FROM BBS WHERE bbs_no=#{bbs_no})
		AND STEP>(SELECT STEP FROM BBS WHERE bbs_no=#{bbs_no})
	</update>
			
	<insert id="replyBBSInsert" parameterType="soccer.co.DTO.foot_comunity_DTO">
		INSERT INTO BBS
		(bbs_no,ID,TITLE,CONTENT,REF,STEP,
		DEPTH, PARENT, DEL, WDATE, READCOUNT)
		VALUES(
		bbs_no_BBS.NEXTVAL,
		#{id},#{title},#{content},
		(SELECT REF FROM BBS WHERE bbs_no=#{bbs_no}),
		(SELECT STEP FROM BBS WHERE bbs_no=#{bbs_no})+1,
		(SELECT DEPTH FROM BBS WHERE bbs_no=#{bbs_no})+1,
		#{bbs_no},0,SYSDATE,0) 
	</insert>
	
	<update id="updateBBS" parameterType="soccer.co.DTO.foot_comunity_DTO">
		UPDATE FOOT_BBS SET 
		TITLE=#{title}, CONTENT=#{content}, WDATE=SYSDATE 
		WHERE bbs_no=#{bbs_no}
	</update>
	
	<update id="delBBS" parameterType="soccer.co.DTO.foot_comunity_DTO">
		UPDATE FOOT_BBS SET 
		DEL=#{del} 
		WHERE bbs_no=#{bbs_no}
	</update>

 </mapper>